<svg width="1600" height="980" viewBox="0 0 1600 980" xmlns="http://www.w3.org/2000/svg" role="img" aria-labelledby="title desc">
  <title id="title">Builtin MCP Task Manager Architecture</title>
  <desc id="desc">Architecture draft for introducing a builtin MCP Task Manager into chat_app_server_rs.</desc>
  <defs>
    <style>
      .bg { fill: #f8fafc; }
      .domain { fill: #eef2ff; stroke: #6366f1; stroke-width: 1.5; rx: 14; }
      .domain2 { fill: #ecfeff; stroke: #0891b2; stroke-width: 1.5; rx: 14; }
      .domain3 { fill: #ecfdf5; stroke: #059669; stroke-width: 1.5; rx: 14; }
      .box { fill: #ffffff; stroke: #334155; stroke-width: 1.2; rx: 10; }
      .box-soft { fill: #f8fafc; stroke: #64748b; stroke-width: 1.1; rx: 10; }
      .title { font: 700 28px Inter, Segoe UI, Arial, sans-serif; fill: #0f172a; }
      .subtitle { font: 600 16px Inter, Segoe UI, Arial, sans-serif; fill: #1e293b; }
      .text { font: 500 13px Inter, Segoe UI, Arial, sans-serif; fill: #1f2937; }
      .small { font: 500 12px Inter, Segoe UI, Arial, sans-serif; fill: #334155; }
      .arrow { stroke: #0f172a; stroke-width: 1.6; fill: none; marker-end: url(#arrowHead); }
      .arrow-dash { stroke: #334155; stroke-width: 1.5; fill: none; stroke-dasharray: 7 6; marker-end: url(#arrowHead); }
      .note { font: 600 12px Inter, Segoe UI, Arial, sans-serif; fill: #475569; }
    </style>
    <marker id="arrowHead" viewBox="0 0 10 10" refX="8.5" refY="5" markerWidth="7" markerHeight="7" orient="auto-start-reverse">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#0f172a"/>
    </marker>
  </defs>

  <rect class="bg" x="0" y="0" width="1600" height="980" />
  <text class="title" x="40" y="54">Builtin MCP Task Manager - Architecture Draft (v1)</text>
  <text class="note" x="40" y="82">Target repo: chat_app_server_rs (builtin MCP pipeline)</text>

  <!-- Domains -->
  <rect class="domain" x="40" y="110" width="470" height="820" />
  <text class="subtitle" x="60" y="138">Client / Control Layer</text>

  <rect class="domain2" x="545" y="110" width="560" height="820" />
  <text class="subtitle" x="565" y="138">MCP Runtime Layer</text>

  <rect class="domain3" x="1140" y="110" width="420" height="820" />
  <text class="subtitle" x="1160" y="138">Persistence / Integration Layer</text>

  <!-- Left boxes -->
  <rect class="box" x="70" y="170" width="410" height="140" />
  <text class="subtitle" x="90" y="202">Chat UI / Agent Request</text>
  <text class="text" x="90" y="228">- User task arrives in session</text>
  <text class="text" x="90" y="250">- Model decides to call MCP tools</text>
  <text class="text" x="90" y="272">- Task tracking expected across turns</text>

  <rect class="box" x="70" y="350" width="410" height="170" />
  <text class="subtitle" x="90" y="382">Backend API Pipeline (v2/v3)</text>
  <text class="text" x="90" y="408">- ai_request_handler -> mcp_tool_execute</text>
  <text class="text" x="90" y="430">- unified tool listing + calling flow</text>
  <text class="text" x="90" y="452">- same runtime for builtin/http/stdio MCP</text>
  <text class="small" x="90" y="480">Files: services/v2|v3/mcp_tool_execute.rs</text>

  <rect class="box" x="70" y="560" width="410" height="170" />
  <text class="subtitle" x="90" y="592">MCP Config &amp; Admin</text>
  <text class="text" x="90" y="618">- builtin MCP listed as readonly</text>
  <text class="text" x="90" y="640">- optional settings endpoint</text>
  <text class="text" x="90" y="662">- future UI for task manager settings</text>
  <text class="small" x="90" y="690">Files: api/configs.rs, chat_app/McpManager.tsx</text>

  <!-- Middle boxes -->
  <rect class="box" x="575" y="170" width="500" height="130" />
  <text class="subtitle" x="595" y="202">mcp_runtime + mcp_loader</text>
  <text class="text" x="595" y="228">- load_mcp_servers_by_selection()</text>
  <text class="text" x="595" y="250">- build McpBuiltinServer(kind = TaskManager)</text>
  <text class="small" x="595" y="276">Files: core/mcp_runtime.rs, services/mcp_loader.rs</text>

  <rect class="box" x="575" y="330" width="500" height="150" />
  <text class="subtitle" x="595" y="362">Builtin Service Factory</text>
  <text class="text" x="595" y="388">- build_builtin_tool_service()</text>
  <text class="text" x="595" y="410">- map BuiltinMcpKind::TaskManager</text>
  <text class="text" x="595" y="432">- expose list_tools()/call_tool()</text>
  <text class="small" x="595" y="458">Files: core/mcp_tools.rs, services/builtin_mcp.rs</text>

  <rect class="box" x="575" y="510" width="500" height="370" />
  <text class="subtitle" x="595" y="542">Builtin Task Manager Service (new)</text>
  <text class="text" x="595" y="568">Tools (MVP):</text>
  <text class="text" x="615" y="592">1) create_task</text>
  <text class="text" x="615" y="614">2) list_tasks</text>
  <text class="text" x="615" y="636">3) get_task</text>
  <text class="text" x="615" y="658">4) update_task</text>
  <text class="text" x="615" y="680">5) transition_task_status</text>
  <text class="text" x="615" y="702">6) add_task_comment</text>
  <text class="text" x="615" y="724">7) get_task_timeline</text>
  <text class="text" x="615" y="746">8) archive_task</text>
  <text class="text" x="595" y="778">Internal components:</text>
  <text class="text" x="615" y="802">- input validators + status transition guard</text>
  <text class="text" x="615" y="824">- TaskStore trait (sqlite/mongo adapters)</text>
  <text class="text" x="615" y="846">- append-only task event writer</text>

  <!-- Right boxes -->
  <rect class="box-soft" x="1170" y="180" width="360" height="130" />
  <text class="subtitle" x="1190" y="212">TaskStore Adapter</text>
  <text class="text" x="1190" y="238">- create/get/list/update APIs</text>
  <text class="text" x="1190" y="260">- optimistic lock by version</text>
  <text class="text" x="1190" y="282">- scoped by project/session</text>

  <rect class="box-soft" x="1170" y="340" width="360" height="170" />
  <text class="subtitle" x="1190" y="372">Database Schema</text>
  <text class="text" x="1190" y="398">SQLite tables:</text>
  <text class="text" x="1210" y="420">- tasks</text>
  <text class="text" x="1210" y="442">- task_events</text>
  <text class="text" x="1190" y="468">Mongo collections mirror same model</text>
  <text class="small" x="1190" y="494">Indexes: (project_id,status,updated_at), (task_id,created_at)</text>

  <rect class="box-soft" x="1170" y="540" width="360" height="150" />
  <text class="subtitle" x="1190" y="572">Event &amp; Observability</text>
  <text class="text" x="1190" y="598">- every mutation emits task_event</text>
  <text class="text" x="1190" y="620">- optional SSE stream for progress</text>
  <text class="text" x="1190" y="642">- logs/metrics for tool usage</text>

  <rect class="box-soft" x="1170" y="720" width="360" height="150" />
  <text class="subtitle" x="1190" y="752">Future Integrations</text>
  <text class="text" x="1190" y="778">- sub_agent_router job -> task sync</text>
  <text class="text" x="1190" y="800">- terminal_controller command checkpoint</text>
  <text class="text" x="1190" y="822">- UI kanban/reporting extensions</text>

  <!-- Arrows -->
  <path class="arrow" d="M 480 240 L 575 240" />
  <path class="arrow" d="M 480 420 L 575 235" />
  <path class="arrow" d="M 480 640 L 575 395" />

  <path class="arrow" d="M 825 300 L 825 330" />
  <path class="arrow" d="M 825 480 L 825 510" />

  <path class="arrow" d="M 1075 580 L 1170 240" />
  <path class="arrow" d="M 1075 640 L 1170 425" />
  <path class="arrow" d="M 1075 700 L 1170 615" />

  <path class="arrow-dash" d="M 1170 785 L 1075 785" />
  <path class="arrow-dash" d="M 730 880 L 730 930 L 280 930 L 280 730" />

  <text class="note" x="745" y="920">Dashed lines = optional phase-2/phase-3 integrations</text>
</svg>
