# 聊天历史折叠新方案（按需加载过程）

## 目标
- 历史列表默认只展示：`用户消息 + AI 最终回答`
- 工具调用和思考过程默认不返回正文，只给统计标签
- 点击“展开过程”后再按需请求该轮过程详情
- 不影响现有流式渲染逻辑
- 支持会话切换、页面切换后回到会话时的状态恢复

## 核心思路

### 1) 后端返回“紧凑历史”
新增 `compact=true` 模式：
- `GET /api/sessions/:session_id/messages?limit=...&offset=...&compact=true`
- 返回结构中：
  - 用户消息会带 `metadata.historyProcess` 统计：
    - `hasProcess`
    - `toolCallCount`
    - `thinkingCount`
    - `processMessageCount`
    - `userMessageId`
    - `finalAssistantMessageId`
  - 过程消息（assistant/tool）会作为**占位消息**返回：
    - `metadata.hidden=true`
    - `metadata.historyProcessPlaceholder=true`
    - `metadata.historyProcessUserMessageId=<userMessageId>`
    - 不返回正文细节
  - 最终 assistant 保留正文，但移除过程段（tool/thinking）

> 这样既能维持前端分页 offset 逻辑稳定，也能保证 UI 默认只看到用户+最终结果。

### 2) 后端新增“单轮过程详情”接口
- `GET /api/sessions/:session_id/turns/:user_message_id/process`
- 返回该用户轮次下（不含最终回答）的 assistant/tool 过程消息详情
- assistant 会补齐 `contentSegments/toolCalls` 供前端直接渲染

## 前端交互方案

### 1) 历史加载
- `fetchSessionMessages` 强制使用 `compact: true`
- 解析后默认只显示 `!hidden && role !== 'tool'`
- 用户消息卡片显示过程标签：
  - `Tools: N`
  - `Thinking: N`
  - `Show process / Hide process`

### 2) 展开过程
点击用户消息上的 `Show process`：
- 若本轮未加载：
  - 调用 `getSessionTurnProcessMessages`
  - 用返回详情替换对应占位消息（按 message id 对齐）
- 若本轮已加载：
  - 仅切换 `metadata.hidden`

### 3) 收起过程
- 仅把本轮过程消息设为 `hidden=true`
- 最终回答保持可见

## 状态与会话切换

新增按会话缓存：
- `sessionTurnProcessState[sessionId][userMessageId]`
  - `expanded / loaded / loading`
- `sessionTurnProcessCache[sessionId][userMessageId] = Message[]`

在 `selectSession/loadMessages/loadMoreMessages` 时：
- 自动应用缓存（替换占位 + 按 expanded 控制显隐）

## 已落地改动清单
- 后端：
  - `chat_app_server_rs/src/api/sessions.rs`
- 前端 API：
  - `chat_app/src/lib/api/client.ts`
  - `chat_app/src/lib/ipc/transport.ts`
- 前端 Store 与 helper：
  - `chat_app/src/lib/store/helpers/messages.ts`
  - `chat_app/src/lib/store/actions/messages.ts`
  - `chat_app/src/lib/store/actions/sessions.ts`
  - `chat_app/src/lib/store/types.ts`
  - `chat_app/src/lib/store/createChatStoreWithBackend.ts`
- UI：
  - `chat_app/src/components/MessageItem.tsx`
  - `chat_app/src/components/MessageList.tsx`
  - `chat_app/src/components/ChatInterface.tsx`
  - `chat_app/src/types/index.ts`

## 验证
- 前端：`npm run type-check` 通过
- 前端：`npm run build` 通过
- 后端：`cargo check --manifest-path chat_app_server_rs/Cargo.toml` 通过
